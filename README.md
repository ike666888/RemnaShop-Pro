# 🚀 RemnaShop-Pro

RemnaShop-Pro 是一个面向 **Remnawave Panel** 的 Telegram 售卖与运维机器人，覆盖“下单审核、自动发货、批量运营、异常风控、客服转发”的完整闭环。

当前版本：`V2.8`

---

## ✨ 功能总览

### 👤 用户端
- 套餐购买 / 续费下单
- 订阅信息查看（流量、到期、订阅链接、二维码）
- 节点状态查看
- 联系客服（支持文字/图片/文件转发）

### 👮 管理端
- 套餐管理（新增/删除 + 流量重置策略）
- 用户管理（重置流量、删除用户、查看请求记录）
- 订单审计（待审核 / 处理中 / 已拒绝 / 已发货 / 失败）
- 失败订单一键重试发货
- 异常检测（可解释告警：风险评分 + 命中证据）
- 异常白名单管理（支持告警消息内快捷加入）
- 订阅设置可视化后台（在 TG 直接查看与JSON更新）
- 用户分组运营（分组列表、可访问节点、批量迁移）
- 带宽看板（TOP节点与请求趋势）
- 风控策略多级化（低：告警 / 中：限速 / 高：禁用）
- 风控回溯面板（记录用户、等级、分数、动作与证据摘要）
- 订阅设置模板与回滚点（模板一键应用、最近快照回滚）
- 分组容量统计与一键迁移建议（基于样本负载自动建议）
- 带宽看板增强（TOP用户流量 + 节点波动提醒）
- 风控观察名单 + 自动解封（中风险限速后可按时自动恢复）
- 操作时间线（订单审计 + 风控回溯 + 配置操作统一视图）
- 批量用户操作（带预检查确认）
  - 批量重置流量
  - 批量禁用
  - 批量删除
  - 批量修改到期时间
  - 批量修改流量包

### 🎨 交互与美化
- 管理员首页展示今日订单/待审核/失败统计
- 订单审计列表中文状态图标化展示
- 订单审计支持分页浏览（上一页 / 下一页）
- 管理按钮与菜单命名全部中文化
- 用户购买流程增加步骤提示（选套餐→选支付方式→提交凭证）

---

## 🧱 项目结构
- `bot.py`：主入口与核心路由
- `services/panel_api.py`：面板接口请求（连接复用 + 重试）
- `services/orders.py`：订单状态机与审计能力
- `storage/db.py`：SQLite 初始化与访问
- `handlers/admin.py`：管理端文案渲染与中文状态映射
- `handlers/client.py`：用户端展示渲染
- `handlers/bulk_actions.py`：批量操作解析、分批执行、预检查
- `jobs/anomaly.py`：异常评分与证据生成
- `jobs/expiry.py`：到期提醒节流工具
- `utils/formatting.py`：MarkdownV2 转义

---


## 🧠 下一步建议（基于当前 API 能力与现有架构）
- 运营效率：增加“订阅设置变更模板”与“最近变更回滚”按钮，避免管理员手写 JSON 出错。
- 分组运营：在“用户分组”增加“分组容量统计 + 一键迁移建议”，降低人工决策成本。
- 带宽看板：补充“TOP 用户流量”与“节点异常波动提醒”，从告警走向趋势运营。
- 风控策略：支持“观察名单”与“自动解封策略（低风险 N 小时后恢复）”，减少误杀影响。
- 审计闭环：订单审计与风控回溯统一成“操作时间线”，可快速定位谁在什么时间做了什么动作。

## 🛠 环境要求
- Debian / Ubuntu VPS
- Python 3.9+
- 可访问 Remnawave Panel API
- Telegram 机器人令牌

---

## 🚀 一键安装 / 更新

```bash
bash <(curl -fsSL https://raw.githubusercontent.com/ike666888/RemnaShop-Pro/main/install.sh)
```

安装脚本会自动完成：
1. 安装 Python 与依赖
2. 同步 `bot.py` 与 `services/ storage/ handlers/ jobs/ utils/` 代码
3. 首次仅生成机器人基础配置（管理员ID + Bot Token）
4. 配置并启动 `remnashop` 系统服务

> 面板地址、面板Token、订阅域名、默认组UUID 现已改为在机器人管理菜单 **「🔌 面板配置」** 内配置。

---

## ⚙️ 配置文件
默认路径：`/opt/RemnaShop/config.json`

关键字段：
- `admin_id`（管理员 Telegram ID）
- `bot_token`（机器人令牌）
- `panel_url`（面板地址，可在机器人「🔌 面板配置」填写）
- `panel_token`（面板接口令牌，可在机器人「🔌 面板配置」填写）
- `sub_domain`（订阅域名，可在机器人「🔌 面板配置」填写）
- `group_uuid`（默认用户组 UUID，可在机器人「🔌 面板配置」填写）
- `panel_verify_tls`（是否校验面板 HTTPS 证书，可在机器人「🔌 面板配置」切换）

---

## 🔧 运维命令
```bash
# 查看日志
journalctl -u remnashop -f

# 重启服务
systemctl restart remnashop

# 查看状态
systemctl status remnashop
```

---

## 📞 联系与支持
* **作者**：ike
* **交流群组**：[点击加入 Remnawave 中文交流群](https://t.me/Remnawarecn)

---

*本项目仅供学习交流使用，请遵守当地法律法规。*
