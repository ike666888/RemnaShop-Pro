# RemnaShop-Pro 代码巡检与改进建议

> 巡检对象：`bot.py`（当前核心逻辑均在单文件中）。

## 已落地修改（本次提交）

1. **修复面板 API TLS 校验默认被关闭的问题**
   - 现状：`httpx.AsyncClient(..., verify=False)` 会关闭 HTTPS 证书校验，存在中间人攻击风险。
   - 修改：新增 `panel_verify_tls` 配置项（默认 `true`），并在请求时使用该配置。
   - 兼容性：如果你的面板证书是自签名，可在 `config.json` 中显式设置 `"panel_verify_tls": false`。

---

## 建议尽快修改（高优先级）

1. **将支付流程改为“订单状态机”并增加幂等校验**
   - 当前依赖管理员手动确认 + 内存 `temp_orders`，重启后状态会丢失。
   - 建议增加 `orders` 表（`pending/approved/rejected/delivered`），每次确认前检查订单状态，避免重复发货。

2. **减少裸 `except`，细化异常类型**
   - 当前代码中有大量 `except: pass`，可能吞掉真实故障。
   - 建议至少记录日志并按异常分类（网络、数据库、Telegram API、业务校验失败）。

3. **拆分单文件结构**
   - `bot.py` 约 800+ 行，维护成本高。
   - 建议拆分为：`handlers/`、`services/panel_api.py`、`services/orders.py`、`storage/db.py`、`jobs/`。

4. **统一消息渲染格式并做转义**
   - 当前多处使用 `parse_mode='Markdown'` 直接插值 URL/用户名。
   - 建议改为 `MarkdownV2` + 统一 escape helper，避免渲染失败或注入问题。

---

## 可新增功能（按业务价值排序）

1. **自动对账（推荐）**
   - 对接支付回调（USDT/易支付等），自动更新订单并发货。
   - 管理端可查看“未支付 / 已支付未发货 / 已发货”。

2. **优惠体系**
   - 优惠码（固定减免 / 百分比 / 首单 / 限次数）。
   - 邀请返佣（邀请关系 + 佣金余额 + 提现记录）。

3. **多管理员与权限分级**
   - 支持客服、运营、超级管理员权限，降低单点风险。

4. **运营看板**
   - 今日新购、续费率、到期人数、节点在线率、异常封禁数。
   - 支持日报推送到管理员。

5. **节点质量可视化**
   - 除在线/离线外，展示延迟、最近故障次数、负载评分。

6. **用户自助“换绑 Telegram”与申诉流程**
   - 降低人工客服负担，提升找回体验。

---

## 工程与稳定性建议

1. **引入基础测试**
   - 至少覆盖：套餐创建、续费叠加、过期清理、异常检测阈值逻辑。

2. **增加速率限制策略**
   - 目前全局冷却较粗粒度，可改为：按功能维度限流（查看状态、发起订单、客服消息）。

3. **数据库优化**
   - 建议为高频字段加索引（`subscriptions(tg_id)`、`subscriptions(uuid)`）。

4. **审计日志**
   - 记录关键管理操作（删除用户、重置流量、改套餐、改阈值），便于追溯。

---

## 建议的下一步实施顺序（两周）

- **第 1 周**：订单状态机 + 幂等发货 + 日志规范化。
- **第 2 周**：支付回调 + 运营看板 + 优惠码 MVP。

